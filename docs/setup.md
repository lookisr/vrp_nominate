# Инструкция по запуску и тестированию проекта

## Предварительные требования

- Docker и Docker Compose
- Node.js 20+ (для локальной разработки фронтенда)
- Python 3.12+ (для локальной разработки бэкенда)

## Вариант 1: Запуск через Docker (рекомендуется)

### 1. Настройка переменных окружения

Скопируйте файл `env.example` в `.env` в корне проекта:

```bash
cp env.example .env
```

Отредактируйте `.env` и укажите:
- `TELEGRAM_BOT_TOKEN` - токен вашего Telegram-бота (получить у @BotFather)
- `ADMIN_IDS` - ваш Telegram ID (можно узнать у @userinfobot), через запятую без пробелов

### 2. Сборка и запуск

```bash
# Сборка образа
docker build -t vrp-app .

# Запуск контейнера
docker run -d \
  --name vrp-app \
  -p 8000:8000 \
  --env-file .env \
  vrp-app
```

Или используйте docker-compose (если создадите docker-compose.yml):

```bash
docker-compose up -d
```

### 3. Проверка работы

- API доступен по адресу: http://localhost:8000
- Health check: http://localhost:8000/health
- API документация: http://localhost:8000/docs
- Фронтенд доступен по адресу: http://localhost:8000

### 4. Создание первой миграции (если нужно)

```bash
# Войдите в контейнер
docker exec -it vrp-app bash

# Перейдите в директорию бэкенда
cd /app/backend

# Создайте миграцию
alembic revision --autogenerate -m "Initial migration"

# Примените миграции
alembic upgrade head
```

## Вариант 2: Локальная разработка

### 1. Настройка базы данных

Запустите PostgreSQL через Docker:

```bash
docker run -d \
  --name vrp-postgres \
  -e POSTGRES_DB=vrp \
  -e POSTGRES_USER=vrp_user \
  -e POSTGRES_PASSWORD=vrp_password \
  -p 5432:5432 \
  postgres:16
```

### 2. Настройка бэкенда

```bash
# Перейдите в директорию бэкенда
cd backend

# Создайте виртуальное окружение
python3 -m venv venv
source venv/bin/activate  # На Windows: venv\Scripts\activate

# Установите зависимости
pip install -r requirements.txt

# Создайте файл .env в backend/
cp ../env.example .env

# Создайте первую миграцию
alembic revision --autogenerate -m "Initial migration"

# Примените миграции
alembic upgrade head

# Запустите сервер
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

### 3. Настройка фронтенда

```bash
# В новом терминале, перейдите в директорию фронтенда
cd frontend

# Установите зависимости
npm install

# Запустите dev-сервер
npm run dev
```

Фронтенд будет доступен по адресу: http://localhost:5173

## Тестирование функционала

### 1. Тестирование API

#### Проверка health check:
```bash
curl http://localhost:8000/health
```

#### Получение списка номинаций:
```bash
curl http://localhost:8000/api/nominations
```

#### Получение номинантов:
```bash
curl http://localhost:8000/api/nominations/1/nominees
```

#### Голосование:
```bash
curl -X POST http://localhost:8000/api/votes \
  -H "Content-Type: application/json" \
  -d '{"nominee_id": 1}'
```

#### Получение результатов:
```bash
curl http://localhost:8000/api/results
```

### 2. Тестирование Telegram-бота

1. Найдите вашего бота в Telegram
2. Отправьте команду `/admin`
3. Если ваш ID в списке администраторов, вы увидите меню
4. Протестируйте:
   - Создание номинации
   - Добавление номинантов
   - Управление голосованием (старт/стоп)
   - Просмотр статистики
   - Экспорт CSV

### 3. Тестирование Mini App

#### Локальное тестирование:
1. Откройте http://localhost:5173 (или http://localhost:8000 в Docker)
2. Проверьте все экраны:
   - Главная страница
   - Список номинаций
   - Голосование
   - Подтверждение голоса
   - Итоги
   - Результаты

#### Тестирование в Telegram:
1. Создайте бота через @BotFather
2. Настройте Mini App:
   ```
   /newapp
   Выберите бота
   Укажите URL: https://your-domain.com
   ```
3. Откройте бота и нажмите кнопку "Открыть приложение"
4. Протестируйте все функции

## Структура тестирования

### Бэкенд:
- ✅ API эндпоинты работают
- ✅ База данных создаётся и миграции применяются
- ✅ Telegram-бот отвечает на команды
- ✅ Изображения сохраняются и проверяются на квадратность
- ✅ Голосование работает и учитывается

### Фронтенд:
- ✅ Все страницы загружаются
- ✅ Навигация работает
- ✅ API запросы выполняются
- ✅ Голосование работает
- ✅ Результаты отображаются корректно

### Интеграция:
- ✅ Telegram Web App SDK инициализируется
- ✅ Бот и API работают вместе
- ✅ Статические файлы отдаются корректно

## Решение проблем

### Проблема: Бот не отвечает
- Проверьте, что `TELEGRAM_BOT_TOKEN` указан правильно
- Убедитесь, что бот запущен (проверьте логи)

### Проблема: Ошибка подключения к БД
- Проверьте, что PostgreSQL запущен
- Проверьте настройки в `.env`
- Убедитесь, что миграции применены

### Проблема: Изображения не загружаются
- Проверьте, что директория `uploads/` существует
- Проверьте права доступа к файлам
- Убедитесь, что путь к изображениям правильный

### Проблема: Миграции не применяются
- Убедитесь, что база данных создана
- Проверьте подключение к БД
- Попробуйте создать миграцию заново: `alembic revision --autogenerate -m "Initial migration"`

## Следующие шаги

После успешного тестирования:
1. Настройте деплой на сервер
2. Настройте домен и SSL
3. Обновите URL Mini App в настройках бота
4. Добавьте мониторинг и логирование

